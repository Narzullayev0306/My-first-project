<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOPIK AI Coach</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="theme-color" content="#111827">
</head>
<body>
    <div id="app" class="app-shell" data-theme="light">
        <div id="splash" class="screen splash-screen active">
            <div class="splash-logo">
                <div class="logo-badge">TOPIK</div>
                <h1>TOPIK AI Coach</h1>
                <p>Mobile-first TOPIK II prep</p>
            </div>
            <div class="loader"></div>
        </div>

        <section id="auth" class="screen auth-screen">
            <div class="phone-frame">
                <header class="app-header minimal">
                    <div class="app-title">TOPIK AI Coach</div>
                    <div class="header-actions">
                        <button class="icon-btn" id="themeToggle" aria-label="Toggle theme">üåì</button>
                        <button class="icon-btn" id="languageToggle" aria-label="Change language">üåê</button>
                    </div>
                </header>

                <div class="auth-card">
                    <div class="segmented">
                        <button class="segmented-btn active" data-auth-tab="login">Log in</button>
                        <button class="segmented-btn" data-auth-tab="register">Register</button>
                    </div>

                    <form id="loginForm" class="auth-form active">
                        <label>
                            <span>Email</span>
                            <input type="email" placeholder="you@example.com" required>
                        </label>
                        <label>
                            <span>Password</span>
                            <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        </label>
                        <button type="submit" class="primary-btn">Log in</button>
                        <button type="button" class="link-btn" id="forgotPasswordBtn">Forgot password?</button>
                    </form>

                    <form id="registerForm" class="auth-form">
                        <label>
                            <span>Email</span>
                            <input type="email" placeholder="you@example.com" required>
                        </label>
                        <label>
                            <span>Password</span>
                            <input type="password" placeholder="Create password" required>
                        </label>
                        <label>
                            <span>Confirm password</span>
                            <input type="password" placeholder="Repeat password" required>
                        </label>
                        <button type="submit" class="primary-btn">Create account</button>
                    </form>

                    <div class="auth-hint" id="forgotPasswordPanel">
                        <p>Reset link sent to your email. (Demo)</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="profile-setup" class="screen profile-setup">
            <div class="phone-frame">
                <header class="app-header">
                    <div class="app-title">Profile Setup</div>
                    <div class="step-indicator" id="stepIndicator">Step 1 of 5</div>
                </header>

                <div class="wizard">
                    <div class="wizard-step active" data-step="1">
                        <h2>Full Name</h2>
                        <p class="muted">Tell us how to address you.</p>
                        <input type="text" id="fullName" placeholder="Full name" required>
                    </div>

                    <div class="wizard-step" data-step="2">
                        <h2>Choose a Username</h2>
                        <p class="muted">Unique nickname used across the app.</p>
                        <input type="text" id="nickname" placeholder="@nickname" required>
                        <p id="nicknameStatus" class="status"></p>
                    </div>

                    <div class="wizard-step" data-step="3">
                        <h2>Current Korean Level</h2>
                        <div class="pill-group" id="currentLevel">
                            <button class="pill active" data-value="Beginner">Beginner</button>
                            <button class="pill" data-value="Intermediate">Intermediate</button>
                            <button class="pill" data-value="Advanced">Advanced</button>
                        </div>
                        <label class="field">
                            <span>Optional TOPIK level</span>
                            <input type="text" id="optionalTopik" placeholder="TOPIK I/II">
                        </label>
                    </div>

                    <div class="wizard-step" data-step="4">
                        <h2>Goals & Schedule</h2>
                        <label class="field">
                            <span>Target TOPIK level</span>
                            <select id="goalLevel">
                                <option value="TOPIK 3">TOPIK 3</option>
                                <option value="TOPIK 4" selected>TOPIK 4</option>
                                <option value="TOPIK 5">TOPIK 5</option>
                                <option value="TOPIK 6">TOPIK 6</option>
                            </select>
                        </label>
                        <label class="field">
                            <span>Exam date</span>
                            <input type="date" id="examDate" required>
                        </label>
                        <label class="field">
                            <span>Daily study minutes</span>
                            <input type="number" id="dailyMinutes" min="10" max="240" value="40" required>
                        </label>
                    </div>

                    <div class="wizard-step" data-step="5">
                        <h2>Profile Photo</h2>
                        <p class="muted">Choose a built-in avatar or upload your own.</p>
                        <div class="avatar-grid" id="avatarGrid"></div>
                        <label class="upload-card">
                            <input type="file" id="photoUpload" accept="image/png,image/jpeg,image/webp">
                            <span>Upload photo (max 3MB)</span>
                        </label>
                        <div id="photoPreview" class="photo-preview"></div>
                    </div>
                </div>

                <div class="wizard-actions">
                    <button class="secondary-btn" id="prevStep">Back</button>
                    <button class="primary-btn" id="nextStep">Next</button>
                </div>
            </div>
        </section>

        <section id="main" class="screen main-app">
            <div class="phone-frame">
                <header class="app-header">
                    <div class="app-title" id="screenTitle">Overview</div>
                    <div class="header-actions">
                        <button class="chip" id="xpChip">Lv 1 ¬∑ Newbie</button>
                        <button class="icon-btn" id="explanationToggle" aria-label="Explanation language">üàØ</button>
                        <button class="icon-btn" id="mainThemeToggle" aria-label="Toggle theme">üåì</button>
                    </div>
                </header>

                <div class="app-content">
                    <section id="tab-overview" class="tab-content active">
                        <div class="hero-card">
                            <div>
                                <h2 id="welcomeText">Welcome back</h2>
                                <p class="muted" id="todayPlan">Today: Writing practice + Grammar review</p>
                            </div>
                            <div class="stat-pill">üî• <span id="streakCount">0</span> day streak</div>
                        </div>

                        <div class="grid">
                            <div class="card">
                                <h3>XP Progress</h3>
                                <div class="progress">
                                    <div class="progress-bar" id="xpBar"></div>
                                </div>
                                <p class="muted" id="xpProgress">0 / 200 XP</p>
                            </div>
                            <div class="card">
                                <h3>Coins</h3>
                                <p class="coins" id="coinBalance">120</p>
                                <button class="secondary-btn" id="quickTopUp">Top up (Demo)</button>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Today Tasks</h3>
                            <ul class="task-list">
                                <li>Grammar drill ¬∑ 15 mins</li>
                                <li>Reading mini test ¬∑ 20 mins</li>
                                <li>Writing Task 54 ¬∑ 25 mins</li>
                            </ul>
                            <div class="quick-actions">
                                <button class="primary-btn" data-action="practice">Start Quiz</button>
                                <button class="secondary-btn" data-action="writing">Writing Lab</button>
                            </div>
                        </div>
                    </section>

                    <section id="tab-practice" class="tab-content">
                        <div class="card">
                            <h3>Practice Mode</h3>
                            <div class="pill-group" id="practiceSkills">
                                <button class="pill active" data-skill="Grammar">Grammar</button>
                                <button class="pill" data-skill="Vocabulary">Vocabulary</button>
                                <button class="pill" data-skill="Reading">Reading</button>
                                <button class="pill" data-skill="Listening">Listening</button>
                            </div>
                            <div class="pill-group" id="practiceDifficulty">
                                <button class="pill active" data-level="Easy">Easy</button>
                                <button class="pill" data-level="Medium">Medium</button>
                                <button class="pill" data-level="Hard">Hard</button>
                            </div>
                        </div>

                        <div class="card question-card">
                            <p class="label">Question (TOPIK II)</p>
                            <h3>Îã§Ïùå Î¨∏Ïû•ÏóêÏÑú ÏïåÎßûÏùÄ Í≤ÉÏùÑ Í≥†Î•¥Ïã≠ÏãúÏò§.</h3>
                            <p class="question">ÌïúÍµ≠Ïñ¥ Í≥µÎ∂ÄÎ•º ÏãúÏûëÌïú ÏßÄ Î≤åÏç® 6Í∞úÏõîÏù¥ ____.</p>
                            <div class="option-grid">
                                <button class="option">A. ÎêòÏóàÎã§</button>
                                <button class="option">B. ÎêúÎã§</button>
                                <button class="option">C. ÎêòÎ©¥</button>
                                <button class="option">D. Îê†Íπå</button>
                            </div>
                            <div class="explanation">
                                <div class="tab-row">
                                    <button class="tab-btn active" data-explanation-tab="explanation">Explanation</button>
                                    <button class="tab-btn" data-explanation-tab="grammar">Grammar</button>
                                    <button class="tab-btn" data-explanation-tab="vocab">Vocabulary</button>
                                </div>
                                <div id="explanationContent" class="explanation-content"></div>
                            </div>
                        </div>
                    </section>

                    <section id="tab-writing" class="tab-content">
                        <div class="card">
                            <h3>Writing Lab (TOPIK II)</h3>
                            <p class="muted">Select a prompt and submit your essay for AI feedback.</p>
                            <div class="prompt-list" id="promptList"></div>
                        </div>

                        <div class="card">
                            <div class="editor-header">
                                <div>
                                    <h3>Essay Editor</h3>
                                    <p class="muted" id="selectedPrompt">Prompt: ÎèÑÏãúÏóêÏÑú ÏÇ¥ ÎïåÏùò Ïû•Îã®Ï†êÏóê ÎåÄÌï¥ Ïì∞Ïã≠ÏãúÏò§.</p>
                                </div>
                                <div class="timer">‚è± 28:00</div>
                            </div>
                            <textarea id="essayInput" rows="8" placeholder="ÌïúÍµ≠Ïñ¥Î°ú ÏóêÏÑ∏Ïù¥Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî..."></textarea>
                            <div class="editor-footer">
                                <span id="wordCount">0 words</span>
                                <button class="primary-btn" id="submitEssay">Submit</button>
                            </div>
                        </div>
                    </section>

                    <section id="tab-store" class="tab-content">
                        <div class="card store-header">
                            <div>
                                <h3>Store & Customization</h3>
                                <p class="muted">Buy cosmetics with coins or demo payments.</p>
                            </div>
                            <button class="secondary-btn" id="openWallet">Wallet</button>
                        </div>

                        <div class="pill-group" id="storeFilters">
                            <button class="pill active" data-filter="all">All</button>
                            <button class="pill" data-filter="avatar">Avatars</button>
                            <button class="pill" data-filter="frame">Frames</button>
                            <button class="pill" data-filter="background">Backgrounds</button>
                        </div>

                        <div class="store-grid" id="storeGrid"></div>
                    </section>

                    <section id="tab-profile" class="tab-content">
                        <div class="card profile-card">
                            <div class="profile-hero" id="profileHero"></div>
                            <div>
                                <h3 id="profileName">Student</h3>
                                <p class="muted" id="profileMeta">Level 1 ¬∑ Newbie</p>
                                <div class="profile-stats">
                                    <div>
                                        <span class="stat-label">XP</span>
                                        <strong id="profileXp">0</strong>
                                    </div>
                                    <div>
                                        <span class="stat-label">Coins</span>
                                        <strong id="profileCoins">0</strong>
                                    </div>
                                    <div>
                                        <span class="stat-label">Streak</span>
                                        <strong id="profileStreak">0</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>Settings</h3>
                            <label class="field">
                                <span>UI language</span>
                                <select id="uiLanguageSelect"></select>
                            </label>
                            <label class="field">
                                <span>Explanation language</span>
                                <select id="explanationLanguageSelect"></select>
                            </label>
                            <label class="field">
                                <span>Theme</span>
                                <select id="themeSelect">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                </select>
                            </label>
                            <button class="secondary-btn" id="logoutBtn">Log out</button>
                        </div>
                    </section>
                </div>

                <nav class="bottom-nav">
                    <button class="nav-item active" data-tab="overview">Overview</button>
                    <button class="nav-item" data-tab="practice">Practice</button>
                    <button class="nav-item" data-tab="writing">Writing Lab</button>
                    <button class="nav-item" data-tab="store">Store</button>
                    <button class="nav-item" data-tab="profile">Profile</button>
                </nav>
            </div>
        </section>

        <div id="walletModal" class="modal">
            <div class="modal-content">
                <h3>Wallet & Top-up (Demo)</h3>
                <p class="muted">All payment providers are sandbox/demo only.</p>
                <div class="payment-grid">
                    <button class="payment-card" data-provider="stripe">Card ¬∑ Stripe Sandbox</button>
                    <button class="payment-card" data-provider="local">Humo/Uzcard Demo</button>
                    <button class="payment-card" data-provider="crypto">Bitcoin Demo</button>
                </div>
                <div id="paymentPanel" class="payment-panel"></div>
                <button class="secondary-btn" id="closeWallet">Close</button>
            </div>
        </div>

        <div id="writingResult" class="modal">
            <div class="modal-content">
                <h3>Writing Feedback (Demo)</h3>
                <div id="writingFeedback"></div>
                <button class="primary-btn" id="closeWriting">Done</button>
            </div>
        </div>

        <div id="toast" class="toast"></div>
    </div>

    <script>
        const state = {
            auth: JSON.parse(localStorage.getItem('auth')) || { loggedIn: false },
            profile: JSON.parse(localStorage.getItem('profile')) || null,
            stats: JSON.parse(localStorage.getItem('stats')) || {
                xp: 120,
                level: 1,
                title: 'Newbie',
                coins: 120,
                streak: 2,
                lastActive: new Date().toISOString()
            },
            uiLanguage: localStorage.getItem('uiLanguage') || 'EN',
            explanationLanguage: localStorage.getItem('explanationLanguage') || 'EN',
            theme: localStorage.getItem('theme') || 'light',
            nicknamePool: JSON.parse(localStorage.getItem('nicknames')) || ['topikpro', 'seoulstudy']
        };

        const i18n = {
            EN: {
                welcome: 'Welcome back',
                today: 'Today: Writing practice + Grammar review',
                login: 'Log in',
                register: 'Register',
                explanation: 'Explanation',
                grammar: 'Grammar',
                vocabulary: 'Vocabulary'
            },
            UZ: {
                welcome: 'Xush kelibsiz',
                today: 'Bugun: Writing mashqi + Grammatika',
                login: 'Kirish',
                register: "Ro'yxatdan o'tish",
                explanation: 'Tushuntirish',
                grammar: 'Grammatika',
                vocabulary: "Lug'at"
            },
            RU: {
                welcome: '–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º',
                today: '–°–µ–≥–æ–¥–Ω—è: –ü–∏—Å—å–º–æ + –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞',
                login: '–í–æ–π—Ç–∏',
                register: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                explanation: '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ',
                grammar: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞',
                vocabulary: '–õ–µ–∫—Å–∏–∫–∞'
            }
        };

        const explanationCopy = {
            EN: {
                explanation: 'Correct answer: A. ÎêòÏóàÎã§. The pattern "-Í≤å ÎêòÎã§" expresses a change over time. Here we use the past tense to show six months have passed.',
                grammar: 'Grammar note: "-Í≤å ÎêòÎã§" indicates a change or result. Past form "-Í≤å ÎêòÏóàÎã§" means it has become/has happened.',
                vocab: 'Vocabulary: Í≥µÎ∂ÄÌïòÎã§ (to study), ÏãúÏûëÌïòÎã§ (to start), Î≤åÏç® (already).'
            },
            UZ: {
                explanation: 'To‚Äòg‚Äòri javob: A. ÎêòÏóàÎã§. "-Í≤å ÎêòÎã§" o‚Äòzgarish yoki vaqt o‚Äòtishi natijasini bildiradi. 6 oy o‚Äòtganini ko‚Äòrsatish uchun o‚Äòtgan zamon ishlatiladi.',
                grammar: 'Grammatika: "-Í≤å ÎêòÎã§" o‚Äòzgarish natijasini bildiradi. "-Í≤å ÎêòÏóàÎã§" ‚Äî o‚Äòtgan zamon.',
                vocab: 'Leksika: Í≥µÎ∂ÄÌïòÎã§ (o‚Äòqimoq), ÏãúÏûëÌïòÎã§ (boshlamoq), Î≤åÏç® (allaqachon).'
            },
            RU: {
                explanation: '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: A. ÎêòÏóàÎã§. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è "-Í≤å ÎêòÎã§" –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º. –ü—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ—à–ª–æ 6 –º–µ—Å—è—Ü–µ–≤.',
                grammar: '–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: "-Í≤å ÎêòÎã§" ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç/–∏–∑–º–µ–Ω–µ–Ω–∏–µ. "-Í≤å ÎêòÏóàÎã§" ‚Äî –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è.',
                vocab: '–õ–µ–∫—Å–∏–∫–∞: Í≥µÎ∂ÄÌïòÎã§ (—É—á–∏—Ç—å), ÏãúÏûëÌïòÎã§ (–Ω–∞—á–∏–Ω–∞—Ç—å), Î≤åÏç® (—É–∂–µ).'
            }
        };

        const levels = [
            { level: 1, xp: 0, title: 'Newbie' },
            { level: 2, xp: 200, title: 'Learner' },
            { level: 3, xp: 450, title: 'TOPIK Warrior' },
            { level: 4, xp: 800, title: 'Master' }
        ];

        const storeItems = [
            { id: 'avatar-1', name: 'Scholar', type: 'avatar', price: 80 },
            { id: 'avatar-2', name: 'Seoul Night', type: 'avatar', price: 120 },
            { id: 'frame-1', name: 'Gold Frame', type: 'frame', price: 150 },
            { id: 'bg-1', name: 'Library', type: 'background', price: 200 }
        ];

        const ownedItems = JSON.parse(localStorage.getItem('ownedItems')) || ['avatar-1'];
        const activeItems = JSON.parse(localStorage.getItem('activeItems')) || { avatar: 'avatar-1' };

        const prompts = [
            'ÎèÑÏãúÏóêÏÑú ÏÇ¥ ÎïåÏùò Ïû•Îã®Ï†êÏóê ÎåÄÌï¥ Ïì∞Ïã≠ÏãúÏò§.',
            'ÌòÑÎåÄ ÏÇ¨ÌöåÏóêÏÑú Ïò®ÎùºÏù∏ ÍµêÏú°Ïùò Ïó≠Ìï†ÏùÑ ÏÑ§Î™ÖÌïòÏã≠ÏãúÏò§.',
            'ÌôòÍ≤Ω Î≥¥Ìò∏Î•º ÏúÑÌï¥ Í∞úÏù∏Ïù¥ Ìï† Ïàò ÏûàÎäî ÏùºÏùÑ Ïì∞Ïã≠ÏãúÏò§.'
        ];

        const app = document.getElementById('app');
        const splash = document.getElementById('splash');
        const authScreen = document.getElementById('auth');
        const profileSetup = document.getElementById('profile-setup');
        const mainScreen = document.getElementById('main');

        const nicknameInput = document.getElementById('nickname');
        const nicknameStatus = document.getElementById('nicknameStatus');
        const stepIndicator = document.getElementById('stepIndicator');
        const steps = Array.from(document.querySelectorAll('.wizard-step'));
        const prevStepBtn = document.getElementById('prevStep');
        const nextStepBtn = document.getElementById('nextStep');
        let currentStep = 1;

        const explanationContent = document.getElementById('explanationContent');
        const explanationTabs = document.querySelectorAll('.tab-btn');

        const storeGrid = document.getElementById('storeGrid');
        const promptList = document.getElementById('promptList');
        const selectedPrompt = document.getElementById('selectedPrompt');
        const essayInput = document.getElementById('essayInput');
        const wordCount = document.getElementById('wordCount');

        const toast = document.getElementById('toast');
        const walletModal = document.getElementById('walletModal');
        const paymentPanel = document.getElementById('paymentPanel');

        const writingModal = document.getElementById('writingResult');
        const writingFeedback = document.getElementById('writingFeedback');

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2600);
        }

        function saveState() {
            localStorage.setItem('auth', JSON.stringify(state.auth));
            localStorage.setItem('profile', JSON.stringify(state.profile));
            localStorage.setItem('stats', JSON.stringify(state.stats));
            localStorage.setItem('uiLanguage', state.uiLanguage);
            localStorage.setItem('explanationLanguage', state.explanationLanguage);
            localStorage.setItem('theme', state.theme);
            localStorage.setItem('nicknames', JSON.stringify(state.nicknamePool));
            localStorage.setItem('ownedItems', JSON.stringify(ownedItems));
            localStorage.setItem('activeItems', JSON.stringify(activeItems));
        }

        function setTheme(theme) {
            state.theme = theme;
            app.dataset.theme = theme;
            saveState();
        }

        function setLanguage(lang) {
            state.uiLanguage = lang;
            saveState();
            updateCopy();
        }

        function setExplanationLanguage(lang) {
            state.explanationLanguage = lang;
            saveState();
            updateExplanation();
        }

        function updateCopy() {
            const copy = i18n[state.uiLanguage];
            document.getElementById('welcomeText').textContent = copy.welcome;
            document.getElementById('todayPlan').textContent = copy.today;
            document.querySelector('[data-auth-tab="login"]').textContent = copy.login;
            document.querySelector('[data-auth-tab="register"]').textContent = copy.register;
            document.querySelector('[data-explanation-tab="explanation"]').textContent = copy.explanation;
            document.querySelector('[data-explanation-tab="grammar"]').textContent = copy.grammar;
            document.querySelector('[data-explanation-tab="vocab"]').textContent = copy.vocabulary;
        }

        function updateExplanation(tab = 'explanation') {
            const lang = state.explanationLanguage;
            if (tab === 'explanation') explanationContent.textContent = explanationCopy[lang].explanation;
            if (tab === 'grammar') explanationContent.textContent = explanationCopy[lang].grammar;
            if (tab === 'vocab') explanationContent.textContent = explanationCopy[lang].vocab;
        }

        function updateStatsUI() {
            const nextLevel = levels.find(level => level.level === state.stats.level + 1) || levels[levels.length - 1];
            const maxXp = nextLevel.xp;
            const progress = Math.min((state.stats.xp / maxXp) * 100, 100);
            document.getElementById('xpBar').style.width = `${progress}%`;
            document.getElementById('xpProgress').textContent = `${state.stats.xp} / ${maxXp} XP`;
            document.getElementById('coinBalance').textContent = state.stats.coins;
            document.getElementById('streakCount').textContent = state.stats.streak;
            document.getElementById('xpChip').textContent = `Lv ${state.stats.level} ¬∑ ${state.stats.title}`;
            document.getElementById('profileXp').textContent = state.stats.xp;
            document.getElementById('profileCoins').textContent = state.stats.coins;
            document.getElementById('profileStreak').textContent = state.stats.streak;
        }

        function updateProfileUI() {
            const name = state.profile?.fullName || 'Student';
            document.getElementById('profileName').textContent = name;
            document.getElementById('profileMeta').textContent = `Level ${state.stats.level} ¬∑ ${state.stats.title}`;
            document.getElementById('welcomeText').textContent = `${i18n[state.uiLanguage].welcome}, ${name.split(' ')[0]}`;
            document.getElementById('profileHero').style.backgroundImage = `url('${state.profile?.photo || ''}')`;
        }

        function updateTabs() {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(section => section.classList.remove('active'));
                    document.getElementById(`tab-${tab}`).classList.add('active');
                    document.getElementById('screenTitle').textContent = btn.textContent;
                });
            });
        }

        function renderStore(filter = 'all') {
            storeGrid.innerHTML = '';
            storeItems
                .filter(item => filter === 'all' || item.type === filter)
                .forEach(item => {
                    const card = document.createElement('div');
                    const owned = ownedItems.includes(item.id);
                    card.className = 'store-card';
                    card.innerHTML = `
                        <div class="store-asset">${item.name.charAt(0)}</div>
                        <h4>${item.name}</h4>
                        <p class="muted">${item.type}</p>
                        <div class="store-footer">
                            <span class="price">${item.price} coins</span>
                            <button class="${owned ? 'secondary-btn' : 'primary-btn'}" data-item="${item.id}">
                                ${owned ? 'Owned' : 'Buy'}
                            </button>
                        </div>
                    `;
                    storeGrid.appendChild(card);
                });
        }

        function renderPrompts() {
            promptList.innerHTML = '';
            prompts.forEach((prompt, index) => {
                const button = document.createElement('button');
                button.className = 'prompt-card';
                button.textContent = `Prompt ${index + 1}: ${prompt}`;
                button.addEventListener('click', () => {
                    selectedPrompt.textContent = `Prompt: ${prompt}`;
                });
                promptList.appendChild(button);
            });
        }

        function initializeWizard() {
            document.getElementById('avatarGrid').innerHTML = ['1', '2', '3', '4'].map(id => `
                <button class="avatar-btn" data-avatar="${id}">
                    <span>AI</span>
                </button>
            `).join('');
        }

        function updateWizard() {
            steps.forEach(step => step.classList.remove('active'));
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            stepIndicator.textContent = `Step ${currentStep} of 5`;
            prevStepBtn.disabled = currentStep === 1;
            nextStepBtn.textContent = currentStep === 5 ? 'Finish' : 'Next';
        }

        function validateNickname() {
            const value = nicknameInput.value.trim().toLowerCase();
            if (!value) {
                nicknameStatus.textContent = 'Nickname is required.';
                nicknameStatus.className = 'status error';
                return false;
            }
            if (state.nicknamePool.includes(value)) {
                nicknameStatus.textContent = 'Nickname already taken.';
                nicknameStatus.className = 'status error';
                return false;
            }
            nicknameStatus.textContent = 'Nickname is available.';
            nicknameStatus.className = 'status success';
            return true;
        }

        function completeProfile() {
            const fullName = document.getElementById('fullName').value.trim();
            const nickname = nicknameInput.value.trim().toLowerCase();
            if (!fullName || !validateNickname()) {
                showToast('Please complete all required fields.');
                return;
            }
            state.profile = {
                fullName,
                nickname,
                currentLevel: document.querySelector('#currentLevel .pill.active').dataset.value,
                goalLevel: document.getElementById('goalLevel').value,
                examDate: document.getElementById('examDate').value,
                dailyMinutes: document.getElementById('dailyMinutes').value,
                photo: document.querySelector('.avatar-btn.selected')?.dataset.src || ''
            };
            state.nicknamePool.push(nickname);
            saveState();
            showScreen(mainScreen);
            updateProfileUI();
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
        }

        function initializeApp() {
            setTheme(state.theme);
            updateCopy();
            updateExplanation();
            updateStatsUI();
            updateProfileUI();
            updateTabs();
            renderStore();
            renderPrompts();
            initializeWizard();
            if (!state.auth.loggedIn) {
                showScreen(authScreen);
                return;
            }
            if (!state.profile) {
                showScreen(profileSetup);
                return;
            }
            showScreen(mainScreen);
        }

        setTimeout(() => {
            splash.classList.remove('active');
            initializeApp();
        }, 1500);

        document.querySelectorAll('.segmented-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.segmented-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
                document.getElementById(`${btn.dataset.authTab}Form`).classList.add('active');
            });
        });

        document.getElementById('loginForm').addEventListener('submit', (event) => {
            event.preventDefault();
            state.auth.loggedIn = true;
            saveState();
            showScreen(state.profile ? mainScreen : profileSetup);
        });

        document.getElementById('registerForm').addEventListener('submit', (event) => {
            event.preventDefault();
            state.auth.loggedIn = true;
            saveState();
            showScreen(profileSetup);
        });

        document.getElementById('forgotPasswordBtn').addEventListener('click', () => {
            document.getElementById('forgotPasswordPanel').classList.add('active');
        });

        nicknameInput.addEventListener('input', validateNickname);

        prevStepBtn.addEventListener('click', () => {
            if (currentStep > 1) {
                currentStep -= 1;
                updateWizard();
            }
        });

        nextStepBtn.addEventListener('click', () => {
            if (currentStep === 2 && !validateNickname()) {
                return;
            }
            if (currentStep === 5) {
                completeProfile();
                return;
            }
            currentStep += 1;
            updateWizard();
        });

        document.getElementById('avatarGrid').addEventListener('click', (event) => {
            const button = event.target.closest('.avatar-btn');
            if (!button) return;
            document.querySelectorAll('.avatar-btn').forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            const avatarUrl = `https://api.dicebear.com/7.x/bottts/svg?seed=${button.dataset.avatar}`;
            button.dataset.src = avatarUrl;
            document.getElementById('photoPreview').innerHTML = `<img src="${avatarUrl}" alt="Avatar preview">`;
        });

        document.getElementById('photoUpload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 3 * 1024 * 1024) {
                showToast('Image exceeds 3MB limit.');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('photoPreview').innerHTML = `<img src="${e.target.result}" alt="Profile preview">`;
                const selected = document.querySelector('.avatar-btn.selected');
                if (selected) selected.classList.remove('selected');
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            setTheme(state.theme === 'light' ? 'dark' : 'light');
        });

        document.getElementById('mainThemeToggle').addEventListener('click', () => {
            setTheme(state.theme === 'light' ? 'dark' : 'light');
        });

        document.getElementById('languageToggle').addEventListener('click', () => {
            const options = ['EN', 'UZ', 'RU'];
            const next = options[(options.indexOf(state.uiLanguage) + 1) % options.length];
            setLanguage(next);
        });

        document.getElementById('explanationToggle').addEventListener('click', () => {
            const options = ['EN', 'UZ', 'RU'];
            const next = options[(options.indexOf(state.explanationLanguage) + 1) % options.length];
            setExplanationLanguage(next);
        });

        explanationTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                explanationTabs.forEach(btn => btn.classList.remove('active'));
                tab.classList.add('active');
                updateExplanation(tab.dataset.explanationTab);
            });
        });

        document.querySelectorAll('#storeFilters .pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#storeFilters .pill').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                renderStore(btn.dataset.filter);
            });
        });

        storeGrid.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button) return;
            const itemId = button.dataset.item;
            if (!itemId) return;
            if (ownedItems.includes(itemId)) {
                showToast('Item already owned.');
                return;
            }
            const item = storeItems.find(i => i.id === itemId);
            if (state.stats.coins < item.price) {
                showToast('Not enough coins. Top up in wallet.');
                return;
            }
            state.stats.coins -= item.price;
            ownedItems.push(itemId);
            saveState();
            updateStatsUI();
            renderStore(document.querySelector('#storeFilters .pill.active').dataset.filter);
            showToast(`Purchased ${item.name}!`);
        });

        document.getElementById('openWallet').addEventListener('click', () => {
            walletModal.classList.add('active');
        });

        document.getElementById('closeWallet').addEventListener('click', () => {
            walletModal.classList.remove('active');
            paymentPanel.innerHTML = '';
        });

        document.getElementById('quickTopUp').addEventListener('click', () => {
            walletModal.classList.add('active');
        });

        document.querySelectorAll('.payment-card').forEach(card => {
            card.addEventListener('click', () => {
                const provider = card.dataset.provider;
                if (provider === 'stripe') {
                    paymentPanel.innerHTML = `
                        <h4>Stripe Sandbox</h4>
                        <p class="muted">Use test card 4242 4242 4242 4242.</p>
                        <button class="primary-btn" id="stripePay">Pay $5 (Demo)</button>
                    `;
                }
                if (provider === 'local') {
                    paymentPanel.innerHTML = `
                        <h4>Humo/Uzcard Demo</h4>
                        <label class="field"><span>Card type</span><select><option>Humo</option><option>Uzcard</option></select></label>
                        <button class="primary-btn" id="localPay">Simulate success</button>
                    `;
                }
                if (provider === 'crypto') {
                    paymentPanel.innerHTML = `
                        <h4>Bitcoin Demo</h4>
                        <p class="muted">Address: bc1demo1234... Amount: 0.0005 BTC</p>
                        <label class="field"><span>TX Hash</span><input type="text" placeholder="Paste hash"></label>
                        <button class="primary-btn" id="cryptoPay">Mark as paid (Demo)</button>
                    `;
                }
            });
        });

        paymentPanel.addEventListener('click', (event) => {
            if (event.target.id === 'stripePay' || event.target.id === 'localPay' || event.target.id === 'cryptoPay') {
                state.stats.coins += 300;
                updateStatsUI();
                saveState();
                showToast('Demo payment successful. +300 coins');
            }
        });

        essayInput.addEventListener('input', () => {
            const words = essayInput.value.trim().split(/\s+/).filter(Boolean);
            wordCount.textContent = `${words.length} words`;
        });

        document.getElementById('submitEssay').addEventListener('click', () => {
            writingFeedback.innerHTML = `
                <div class="feedback-grid">
                    <div class="feedback-card">Task fulfillment: 3/5</div>
                    <div class="feedback-card">Coherence: 3/5</div>
                    <div class="feedback-card">Grammar: 2/5</div>
                    <div class="feedback-card">Vocabulary: 3/5</div>
                    <div class="feedback-card">Formal tone: 4/5</div>
                </div>
                <p class="muted">Estimated score: 34-38/50</p>
                <p>Corrections: Ï°∞ÏÇ¨ ÏÇ¨Ïö©Ïù¥ Î∂àÏïàÏ†ïÌï©ÎãàÎã§. Îî∞ÎùºÏÑú, "ÎèÑÏãúÏóê ÏÇ¥ Îïå" ÌëúÌòÑÏùÑ Îçî Î™ÖÌôïÌûà ÌïòÏÑ∏Ïöî.</p>
                <p class="muted">Rewrite suggestion: ...</p>
            `;
            writingModal.classList.add('active');
            state.stats.xp += Math.min(50, essayInput.value.length / 8);
            updateStatsUI();
            saveState();
        });

        document.getElementById('closeWriting').addEventListener('click', () => {
            writingModal.classList.remove('active');
        });

        document.querySelectorAll('.pill-group').forEach(group => {
            group.addEventListener('click', (event) => {
                const pill = event.target.closest('.pill');
                if (!pill) return;
                group.querySelectorAll('.pill').forEach(btn => btn.classList.remove('active'));
                pill.classList.add('active');
            });
        });

        document.querySelectorAll('.quick-actions button').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.action === 'practice' ? 'practice' : 'writing';
                document.querySelector(`.nav-item[data-tab="${target}"]`).click();
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            state.auth.loggedIn = false;
            saveState();
            showScreen(authScreen);
        });

        document.getElementById('uiLanguageSelect').addEventListener('change', (event) => {
            setLanguage(event.target.value);
        });

        document.getElementById('explanationLanguageSelect').addEventListener('change', (event) => {
            setExplanationLanguage(event.target.value);
        });

        document.getElementById('themeSelect').addEventListener('change', (event) => {
            setTheme(event.target.value);
        });

        window.addEventListener('load', () => {
            updateWizard();
            ['EN', 'UZ', 'RU'].forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = lang;
                document.getElementById('uiLanguageSelect').appendChild(option.cloneNode(true));
                document.getElementById('explanationLanguageSelect').appendChild(option);
            });
            document.getElementById('uiLanguageSelect').value = state.uiLanguage;
            document.getElementById('explanationLanguageSelect').value = state.explanationLanguage;
            document.getElementById('themeSelect').value = state.theme;
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js');
            });
        }
    </script>
</body>
</html>
